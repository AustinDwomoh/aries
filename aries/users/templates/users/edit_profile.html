{% extends "base.html" %}
{% load static crispy_forms_tags %}
{% block title %}{{ user.username }}{% endblock %}
{% block content %}
<style>
  body { background-color: #fff !important; }
</style>

<section>
  <!-- Forms with Tabs -->
  <div class="container-fluid mt-4">
      <!-- Tab Navigation -->
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#account" role="tab">Account</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#profile" role="tab">Profile</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#social-links" role="tab">Social Links</a>
      </li>
      <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#password" role="tab">Password</a>
      </li>
    </ul>

    <div class="tab-content mt-3">

      <!-- Account Tab -->
      <div class="tab-pane fade show active" id="account" role="tabpanel">
          <div class="container mt-3">
            <form method="post" enctype="multipart/form-data" id="account-form" style="width: auto;">

                {% csrf_token %}
                {{ u_form|crispy }}
                <button type="submit" class="btn  mt-3">Save Account</button>
            </form>
          </div>
      </div>

      <!-- Profile Tab -->
      <div class="tab-pane fade" id="profile" role="tabpanel">
        <div class="container mt-3">
          <form method="post" enctype="multipart/form-data" id="profile-form">
              {% csrf_token %}
              {{ p_form|crispy }}
              <button type="submit" class="btn  mt-3">Save Profile</button>
          </form>
          </div>
      </div>

      <!-- Social Links Tab -->
      <div class="tab-pane fade" id="social-links" role="tabpanel">
        <div class="container mt-3">
          <form method="post" id="social-links-form" style="width: auto;">
              {% csrf_token %}
              {{ social_formset.management_form }}
              <div id="social-links-formset" class="mb-3">
                  {% for form in social_formset %}
                      <div class="card p-3 mb-2 border social-form">
                          <div class="row g-2 align-items-center">
                              <div class="col-md-3 col-sm-12">{{ form.link_type|as_crispy_field }}</div>
                              <div class="col-md-5">{{ form.url|as_crispy_field }}</div>
                              <div class="col-md-2">{{ form.display_order|as_crispy_field }}</div>
                              <div class="col-md-1">{{ form.is_active|as_crispy_field }}</div>
                              <div class="col-md-1 text-center">
                                  {% if form.instance.pk %}
                                      {{ form.DELETE }} <small>Delete</small>
                                  {% else %}
                                      <button type="button" class="btn btn-danger btn-sm remove-form">✖</button>
                                  {% endif %}
                              </div>
                          </div>
                      </div>
                  {% endfor %}
              </div>
              <button type="button" class="btn btn-outline-primary mt-2" id="add-social-form">+ Add Social Link</button>
              <button type="submit" class="btn  mt-3">Save Social Links</button>
          </form>
        </div>
      </div>

      <!-- Password Tab -->
      <div class="tab-pane fade" id="password" role="tabpanel">
        <div class="container mt-3">
          <form method="post" id="password-form">
              {% csrf_token %}
              {{ pass_form|crispy }}
              <button type="submit" class="btn  mt-3">Change Password</button>
          </form>
          </div>
      </div>

    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const formsetDiv = document.getElementById("social-links-formset");
    const addFormButton = document.getElementById("add-social-form");
    const totalForms = document.querySelector("#social-links-form input[name$='-TOTAL_FORMS']");

    addFormButton.addEventListener("click", function () {
        const formCount = parseInt(totalForms.value);
        const newFormHtml = document.querySelector(".social-form").outerHTML.replace(
            /social_formset-\d+/g,
            `social_formset-${formCount}`
        );
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = newFormHtml;

        // Clear inputs in the new form
        tempDiv.querySelectorAll("input, select").forEach(input => {
            if (input.type === "checkbox" || input.type === "radio") input.checked = false;
            else input.value = "";
        });

        // Update remove button
        const col = tempDiv.querySelector(".col-md-1.text-center");
        if (col) col.innerHTML = `<button type="button" class="btn btn-danger btn-sm remove-form">✖</button>`;

        formsetDiv.appendChild(tempDiv.firstElementChild);
        totalForms.value = formCount + 1;
    });

    // Remove form on clicking the X button
    formsetDiv.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove-form")) {
            e.target.closest(".social-form").remove();

            const updatedCount = document.querySelectorAll(".social-form").length;
            totalForms.value = updatedCount;

            // Rename inputs so Django can process them correctly
            document.querySelectorAll(".social-form").forEach((form, index) => {
                form.querySelectorAll("[name], [id]").forEach(el => {
                    if (el.name) el.name = el.name.replace(/social_formset-\d+/, `social_formset-${index}`);
                    if (el.id) el.id = el.id.replace(/social_formset-\d+/, `social_formset-${index}`);
                });
            });
        }
    });
});

document.addEventListener("DOMContentLoaded", function () {
    const passwordTab = document.querySelector('#password');
    const passwordFields = passwordTab.querySelectorAll('input');

    document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tabLink => {
        tabLink.addEventListener('shown.bs.tab', function (e) {
            if (e.target.getAttribute('href') === '#password') {
                passwordFields.forEach(f => f.required = true);
            } else {
                passwordFields.forEach(f => f.required = false);
            }
        });
    });
});

</script>
{% endblock %}

